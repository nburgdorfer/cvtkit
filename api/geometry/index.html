
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../datasets_dtu/">
      
      
        <link rel="next" href="../filtering/">
      
      <link rel="icon" href="../../assets/logo.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.1">
    
    
      
        <title>Geometry - Computer Vision Toolkit</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3bd4f189.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="deep-purple">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cvt.geometry" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Computer Vision Toolkit" class="md-header__button md-logo" aria-label="Computer Vision Toolkit" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Computer Vision Toolkit
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Geometry
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="deep-purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="orange" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
            </label>
          
        
      </form>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/nburgdorfer/cvtkit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    nbugdorfer/cvtkit
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        Home
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../tutorials/gen_vis_maps/" class="md-tabs__link">
        Tutorials
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../camera/" class="md-tabs__link md-tabs__link--active">
        API Reference
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../resources/pose_file_formats/" class="md-tabs__link">
        Resources
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../development/contrib/" class="md-tabs__link">
        Development
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Computer Vision Toolkit" class="md-nav__button md-logo" aria-label="Computer Vision Toolkit" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    Computer Vision Toolkit
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/nburgdorfer/cvtkit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    nbugdorfer/cvtkit
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Home
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Home" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Computer Vision Toolkit
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tutorials" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/gen_vis_maps/" class="md-nav__link">
        Generate Visibility Maps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/mesh_to_gif/" class="md-nav__link">
        Mesh To GIF
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/mesh_to_vid/" class="md-nav__link">
        Mesh To Video
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/cloud_to_gif/" class="md-nav__link">
        Point Cloud To GIF
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/cloud_to_vid/" class="md-nav__link">
        Point Cloud To Video
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../camera/" class="md-nav__link">
        Camera
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common/" class="md-nav__link">
        Common
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../io/" class="md-nav__link">
        IO
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" type="checkbox" id="__nav_3_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_4">
          Datasets
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Datasets" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          Datasets
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../datasets_dtu/" class="md-nav__link">
        DTU
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Geometry
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Geometry
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry" class="md-nav__link">
    cvt.geometry
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.compute_plane_coords" class="md-nav__link">
    compute_plane_coords()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.essential_from_features" class="md-nav__link">
    essential_from_features()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.fundamental_from_KP" class="md-nav__link">
    fundamental_from_KP()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.fundamental_from_features" class="md-nav__link">
    fundamental_from_features()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.geometric_consistency_error" class="md-nav__link">
    geometric_consistency_error()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.geometric_consistency_mask" class="md-nav__link">
    geometric_consistency_mask()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.homography" class="md-nav__link">
    homography()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.match_features" class="md-nav__link">
    match_features()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.point_cloud_from_depth" class="md-nav__link">
    point_cloud_from_depth()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.points_from_depth" class="md-nav__link">
    points_from_depth()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.project_depth_map" class="md-nav__link">
    project_depth_map()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.project_renderer" class="md-nav__link">
    project_renderer()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.render_custom_values" class="md-nav__link">
    render_custom_values()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.render_point_cloud" class="md-nav__link">
    render_point_cloud()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.reproject" class="md-nav__link">
    reproject()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.visibility_mask" class="md-nav__link">
    visibility_mask()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.warp_to_tgt" class="md-nav__link">
    warp_to_tgt()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../filtering/" class="md-nav__link">
        Filtering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../metrics/" class="md-nav__link">
        Metrics
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_8" type="checkbox" id="__nav_3_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_8">
          Visualization
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Visualization" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_8">
          <span class="md-nav__icon md-icon"></span>
          Visualization
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../visualization_latex/" class="md-nav__link">
        Latex
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../visualization_util/" class="md-nav__link">
        Utilities
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../visualization_video/" class="md-nav__link">
        Video
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Resources
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Resources" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Resources
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/pose_file_formats/" class="md-nav__link">
        Pose File Formats
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Development
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Development" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Development
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../development/contrib/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../development/conduct/" class="md-nav__link">
        Code of Conduct
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry" class="md-nav__link">
    cvt.geometry
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.compute_plane_coords" class="md-nav__link">
    compute_plane_coords()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.essential_from_features" class="md-nav__link">
    essential_from_features()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.fundamental_from_KP" class="md-nav__link">
    fundamental_from_KP()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.fundamental_from_features" class="md-nav__link">
    fundamental_from_features()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.geometric_consistency_error" class="md-nav__link">
    geometric_consistency_error()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.geometric_consistency_mask" class="md-nav__link">
    geometric_consistency_mask()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.homography" class="md-nav__link">
    homography()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.match_features" class="md-nav__link">
    match_features()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.point_cloud_from_depth" class="md-nav__link">
    point_cloud_from_depth()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.points_from_depth" class="md-nav__link">
    points_from_depth()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.project_depth_map" class="md-nav__link">
    project_depth_map()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.project_renderer" class="md-nav__link">
    project_renderer()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.render_custom_values" class="md-nav__link">
    render_custom_values()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.render_point_cloud" class="md-nav__link">
    render_point_cloud()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.reproject" class="md-nav__link">
    reproject()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.visibility_mask" class="md-nav__link">
    visibility_mask()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cvt.geometry.warp_to_tgt" class="md-nav__link">
    warp_to_tgt()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



  <h1>Geometry</h1>

<div class="doc doc-object doc-module">


<a id="cvt.geometry"></a>
  <div class="doc doc-contents first">
  
      <p>Module including geometric routines.</p>
<p>This module contains the following functions:</p>
<ul>
<li><code>essential_from_features(src_image_file, tgt_image_file, K)</code> - Computes the essential matrix between two images using image features.</li>
<li><code>fundamental_from_KP(K, P_src, P_tgt)</code> - Computes the fundamental matrix between two images using camera parameters.</li>
<li><code>fundamental_from_features(src_image_file, tgt_image_file)</code> - Computes the fundamental matrix between two images using image features.</li>
<li><code>geometric_consistency_mask(src_depth, src_cam, tgt_depth, tgt_cam, pixel_th)</code> - Computes the geometric consistency mask between a source and target depth map.</li>
<li><code>homography(src_image_file, tgt_image_file)</code> - Computes a homography transformation between two images using image features.</li>
<li><code>match_features(src_image, tgt_image, max_features)</code> - Computer matching ORB features between a pair of images.</li>
<li><code>point_cloud_from_depth(depth, cam, color)</code> - Creates a point cloud from a single depth map.</li>
<li><code>points_from_depth(depth, cam)</code> - Creates a point array from a single depth map.</li>
<li><code>project_depth_map(depth, cam, mask)</code> - Projects a depth map into a list of 3D points.</li>
<li><code>project_renderer(renderer, K, P, width, height)</code> - Projects the scene in an Open3D Offscreen Renderer to the 2D image plane.</li>
<li><code>render_custom_values(points, values, image_shape, cam)</code> - Renders a point cloud into a 2D camera plane using custom values for each pixel.</li>
<li><code>render_point_cloud(cloud, cam, width, height)</code> - Renders a point cloud into a 2D image plane.</li>
<li><code>reproject(src_depth, src_cam, tgt_depth, tgt_cam)</code> - Computes the re-projection depth values and pixel indices between two depth maps.</li>
<li><code>visibility_mask(src_depth, src_cam, depth_files, cam_files, src_ind=-1, pixel_th=0.1)</code> - Computes a visibility mask between a provided source depth map and list of target depth maps.</li>
</ul>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.compute_plane_coords" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_plane_coords</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">depth_hypos</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Batched PyTorch version</p>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_plane_coords</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">depth_hypos</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Batched PyTorch version</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch_size</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">num_planes</span> <span class="o">=</span> <span class="n">depth_hypos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">xyz</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">movedim</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">W</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">H</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">W</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">H</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">K</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">K_44</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">K_44</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">K_44</span><span class="p">[:,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">K_44</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">K</span> <span class="o">@</span> <span class="n">P</span>
    <span class="n">inv_proj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>

    <span class="n">planes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_planes</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">inv_proj</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_planes</span><span class="p">):</span>
        <span class="n">planes</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">inv_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span> <span class="o">@</span> <span class="n">xyz</span><span class="p">)</span> <span class="o">*</span> <span class="n">depth_hypos</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="n">planes</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">+=</span> <span class="n">inv_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">planes</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.essential_from_features" class="doc doc-heading">
<code class="highlight language-python"><span class="n">essential_from_features</span><span class="p">(</span><span class="n">src_image_file</span><span class="p">,</span> <span class="n">tgt_image_file</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Computes the essential matrix between two images using image features.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src_image_file</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Input file for the source image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_image_file</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Input file for the target image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>K</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Intrinsics matrix of the two cameras (assumed to be constant between views).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The essential matrix betweent the two image views.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">essential_from_features</span><span class="p">(</span><span class="n">src_image_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tgt_image_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the essential matrix between two images using image features.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        src_image_file: Input file for the source image.</span>
<span class="sd">        tgt_image_file: Input file for the target image.</span>
<span class="sd">        K: Intrinsics matrix of the two cameras (assumed to be constant between views).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The essential matrix betweent the two image views.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">src_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">src_image_file</span><span class="p">)</span>
    <span class="n">tgt_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">tgt_image_file</span><span class="p">)</span>

    <span class="c1"># compute matching features</span>
    <span class="p">(</span><span class="n">src_points</span><span class="p">,</span> <span class="n">tgt_points</span><span class="p">)</span> <span class="o">=</span> <span class="n">match_features</span><span class="p">(</span><span class="n">src_image</span><span class="p">,</span> <span class="n">tgt_image</span><span class="p">)</span>

    <span class="c1"># Compute fundamental matrix</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findEssentialMat</span><span class="p">(</span><span class="n">src_points</span><span class="p">,</span> <span class="n">tgt_points</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">RANSAC</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">E</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.fundamental_from_KP" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fundamental_from_KP</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">P_src</span><span class="p">,</span> <span class="n">P_tgt</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Computes the fundamental matrix between two images using camera parameters.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>K</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Intrinsics matrix of the two cameras (assumed to be constant between views).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>P_src</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Extrinsics matrix for the source view.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>P_tgt</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Extrinsics matrix for the target view.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The fundamental matrix betweent the two cameras.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fundamental_from_KP</span><span class="p">(</span><span class="n">K</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">P_src</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">P_tgt</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the fundamental matrix between two images using camera parameters.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        K: Intrinsics matrix of the two cameras (assumed to be constant between views).</span>
<span class="sd">        P_src: Extrinsics matrix for the source view.</span>
<span class="sd">        P_tgt: Extrinsics matrix for the target view.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The fundamental matrix betweent the two cameras.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">R1</span> <span class="o">=</span> <span class="n">P_src</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">P_src</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="n">P_tgt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">P_tgt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">t1aug</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">epi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">P_tgt</span><span class="p">,</span><span class="n">t1aug</span><span class="p">)</span>
    <span class="n">epi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">epi2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">R2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">R1</span><span class="p">))</span>
    <span class="n">t</span><span class="o">=</span> <span class="n">t2</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span>
    <span class="n">K1inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">K2invT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">K1inv</span><span class="p">)</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]])</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">K2invT</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">K1inv</span><span class="p">)))</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">F</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">F</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.fundamental_from_features" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fundamental_from_features</span><span class="p">(</span><span class="n">src_image_file</span><span class="p">,</span> <span class="n">tgt_image_file</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Computes the fundamental matrix between two images using image features.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src_image_file</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Input file for the source image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_image_file</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Input file for the target image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The fundamental matrix betweent the two image views.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fundamental_from_features</span><span class="p">(</span><span class="n">src_image_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tgt_image_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the fundamental matrix between two images using image features.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        src_image_file: Input file for the source image.</span>
<span class="sd">        tgt_image_file: Input file for the target image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The fundamental matrix betweent the two image views.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">src_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">src_image_file</span><span class="p">)</span>
    <span class="n">tgt_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">tgt_image_file</span><span class="p">)</span>

    <span class="c1"># compute matching features</span>
    <span class="p">(</span><span class="n">src_points</span><span class="p">,</span> <span class="n">tgt_points</span><span class="p">)</span> <span class="o">=</span> <span class="n">match_features</span><span class="p">(</span><span class="n">src_image</span><span class="p">,</span> <span class="n">tgt_image</span><span class="p">)</span>

    <span class="c1"># Compute fundamental matrix</span>
    <span class="n">F</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findFundamentalMat</span><span class="p">(</span><span class="n">src_points</span><span class="p">,</span><span class="n">tgt_points</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">FM_8POINT</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">F</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.geometric_consistency_error" class="doc doc-heading">
<code class="highlight language-python"><span class="n">geometric_consistency_error</span><span class="p">(</span><span class="n">src_depth</span><span class="p">,</span> <span class="n">src_cam</span><span class="p">,</span> <span class="n">tgt_depth</span><span class="p">,</span> <span class="n">tgt_cam</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Computes the geometric consistency error between a source and target depth map.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src_depth</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Depth map for the source view.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>src_cam</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Camera parameters for the source depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_depth</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Depth map for the target view.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_cam</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Camera parameters for the target depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The binary consistency mask encoding depth consensus between source and target depth maps.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">geometric_consistency_error</span><span class="p">(</span><span class="n">src_depth</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">src_cam</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tgt_depth</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tgt_cam</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the geometric consistency error between a source and target depth map.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        src_depth: Depth map for the source view.</span>
<span class="sd">        src_cam: Camera parameters for the source depth map viewpoint.</span>
<span class="sd">        tgt_depth: Depth map for the target view.</span>
<span class="sd">        tgt_cam: Camera parameters for the target depth map viewpoint.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The binary consistency mask encoding depth consensus between source and target depth maps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">src_depth</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x_src</span><span class="p">,</span> <span class="n">y_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>

    <span class="n">depth_reprojected</span><span class="p">,</span> <span class="n">coords_reprojected</span><span class="p">,</span> <span class="n">coords_tgt</span><span class="p">,</span> <span class="n">projection_map</span> <span class="o">=</span> <span class="n">reproject</span><span class="p">(</span><span class="n">src_depth</span><span class="p">,</span> <span class="n">src_cam</span><span class="p">,</span> <span class="n">tgt_depth</span><span class="p">,</span> <span class="n">tgt_cam</span><span class="p">)</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">coords_reprojected</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_src</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">coords_reprojected</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_src</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dist</span><span class="p">,</span> <span class="n">projection_map</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.geometric_consistency_mask" class="doc doc-heading">
<code class="highlight language-python"><span class="n">geometric_consistency_mask</span><span class="p">(</span><span class="n">src_depth</span><span class="p">,</span> <span class="n">src_K</span><span class="p">,</span> <span class="n">src_P</span><span class="p">,</span> <span class="n">tgt_depth</span><span class="p">,</span> <span class="n">tgt_K</span><span class="p">,</span> <span class="n">tgt_P</span><span class="p">,</span> <span class="n">pixel_th</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Computes the geometric consistency mask between a source and target depth map.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src_depth</code></td>
          <td>
          </td>
          <td><p>Depth map for the source view.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>src_K</code></td>
          <td>
          </td>
          <td><p>Intrinsic camera parameters for the source depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>src_P</code></td>
          <td>
          </td>
          <td><p>Extrinsic camera parameters for the source depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_depth</code></td>
          <td>
          </td>
          <td><p>Target depth map used for re-projection.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_K</code></td>
          <td>
          </td>
          <td><p>Intrinsic camera parameters for the target depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_P</code></td>
          <td>
          </td>
          <td><p>Extrinsic camera parameters for the target depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>pixel_th</code></td>
          <td>
          </td>
          <td><p>Pixel re-projection threshold to determine matching depth estimates.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>The binary consistency mask encoding depth consensus between source and target depth maps.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">geometric_consistency_mask</span><span class="p">(</span><span class="n">src_depth</span><span class="p">,</span> <span class="n">src_K</span><span class="p">,</span> <span class="n">src_P</span><span class="p">,</span> <span class="n">tgt_depth</span><span class="p">,</span> <span class="n">tgt_K</span><span class="p">,</span> <span class="n">tgt_P</span><span class="p">,</span> <span class="n">pixel_th</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the geometric consistency mask between a source and target depth map.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        src_depth: Depth map for the source view.</span>
<span class="sd">        src_K: Intrinsic camera parameters for the source depth map viewpoint.</span>
<span class="sd">        src_P: Extrinsic camera parameters for the source depth map viewpoint.</span>
<span class="sd">        tgt_depth: Target depth map used for re-projection.</span>
<span class="sd">        tgt_K: Intrinsic camera parameters for the target depth map viewpoint.</span>
<span class="sd">        tgt_P: Extrinsic camera parameters for the target depth map viewpoint.</span>
<span class="sd">        pixel_th: Pixel re-projection threshold to determine matching depth estimates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The binary consistency mask encoding depth consensus between source and target depth maps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch_size</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">src_depth</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">depth_reprojected</span><span class="p">,</span> <span class="n">coords_reprojected</span><span class="p">,</span> <span class="n">coords_tgt</span> <span class="o">=</span> <span class="n">reproject</span><span class="p">(</span><span class="n">src_depth</span><span class="p">,</span> <span class="n">src_K</span><span class="p">,</span> <span class="n">src_P</span><span class="p">,</span> <span class="n">tgt_depth</span><span class="p">,</span> <span class="n">tgt_K</span><span class="p">,</span> <span class="n">tgt_P</span><span class="p">)</span>

    <span class="n">x_src</span><span class="p">,</span> <span class="n">y_src</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;xy&quot;</span><span class="p">)</span>
    <span class="n">x_src</span> <span class="o">=</span> <span class="n">x_src</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">src_depth</span><span class="p">)</span>
    <span class="n">y_src</span> <span class="o">=</span> <span class="n">y_src</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">src_depth</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">coords_reprojected</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_src</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">coords_reprojected</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_src</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">pixel_th</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.homography" class="doc doc-heading">
<code class="highlight language-python"><span class="n">homography</span><span class="p">(</span><span class="n">src_image_file</span><span class="p">,</span> <span class="n">tgt_image_file</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Computes a homography transformation between two images using image features.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src_image_file</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Input file for the source image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_image_file</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Input file for the target image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The homography matrix to warp the target image to the source image.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">homography</span><span class="p">(</span><span class="n">src_image_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tgt_image_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes a homography transformation between two images using image features.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        src_image_file: Input file for the source image.</span>
<span class="sd">        tgt_image_file: Input file for the target image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The homography matrix to warp the target image to the source image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">src_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">src_image_file</span><span class="p">)</span>
    <span class="n">tgt_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">tgt_image_file</span><span class="p">)</span>

    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">src_image</span><span class="o">.</span><span class="n">shape</span>

    <span class="p">(</span><span class="n">src_points</span><span class="p">,</span> <span class="n">tgt_points</span><span class="p">)</span> <span class="o">=</span> <span class="n">match_features</span><span class="p">(</span><span class="n">src_image</span><span class="p">,</span> <span class="n">tgt_image</span><span class="p">)</span>

    <span class="c1"># Compute fundamental matrix</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findHomography</span><span class="p">(</span><span class="n">tgt_points</span><span class="p">,</span> <span class="n">src_points</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">RANSAC</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">H</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.match_features" class="doc doc-heading">
<code class="highlight language-python"><span class="n">match_features</span><span class="p">(</span><span class="n">src_image</span><span class="p">,</span> <span class="n">tgt_image</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Computer matching ORB features between a pair of images.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src_image</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The source image to compute and match features.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_image</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The target image to compute and match features.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>max_features</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The maximum number of features to retain.</p></td>
          <td>
                <code>500</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>src_points</code></td>          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The set of matched point coordinates for the source image.</p></td>
        </tr>
        <tr>
<td><code>tgt_points</code></td>          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The set of matched point coordinates for the target image.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">match_features</span><span class="p">(</span><span class="n">src_image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tgt_image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">max_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computer matching ORB features between a pair of images.</span>

<span class="sd">    Args:</span>
<span class="sd">        src_image: The source image to compute and match features.</span>
<span class="sd">        tgt_image: The target image to compute and match features.</span>
<span class="sd">        max_features: The maximum number of features to retain.</span>

<span class="sd">    Returns:</span>
<span class="sd">        src_points: The set of matched point coordinates for the source image.</span>
<span class="sd">        tgt_points: The set of matched point coordinates for the target image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">src_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">src_image</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">tgt_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">tgt_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

    <span class="n">orb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ORB_create</span><span class="p">(</span><span class="n">max_features</span><span class="p">)</span>

    <span class="n">src_keypoints</span><span class="p">,</span> <span class="n">src_descriptors</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">src_image</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">tgt_keypoints</span><span class="p">,</span> <span class="n">tgt_descriptors</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">tgt_image</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">matcher</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">crossCheck</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matcher</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">src_descriptors</span><span class="p">,</span> <span class="n">tgt_descriptors</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">matches</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span>

    <span class="n">src_points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tgt_points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">src_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src_keypoints</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">queryIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">tgt_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tgt_keypoints</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">trainIdx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>
    <span class="n">src_points</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">src_points</span><span class="p">)</span>
    <span class="n">tgt_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tgt_points</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">src_points</span><span class="p">,</span> <span class="n">tgt_points</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.point_cloud_from_depth" class="doc doc-heading">
<code class="highlight language-python"><span class="n">point_cloud_from_depth</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Creates a point cloud from a single depth map.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>depth</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Depth map to project to 3D.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cam</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Camera parameters for the given depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>color</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Color [R,G,B] used for all points in the generated point cloud.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">point_cloud_from_depth</span><span class="p">(</span><span class="n">depth</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cam</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">PointCloud</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a point cloud from a single depth map.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        depth: Depth map to project to 3D.</span>
<span class="sd">        cam: Camera parameters for the given depth map viewpoint.</span>
<span class="sd">        color: Color [R,G,B] used for all points in the generated point cloud.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cloud</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">PointCloud</span><span class="p">()</span>

    <span class="c1"># extract camera params</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">fx</span> <span class="o">=</span> <span class="n">cam</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fy</span> <span class="o">=</span> <span class="n">cam</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="n">cam</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="n">cam</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">intrins</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">PinholeCameraIntrinsic</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span>
    <span class="n">extrins</span> <span class="o">=</span> <span class="n">cam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># convert deth to o3d.geometry.Image</span>
    <span class="n">depth_map</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>

    <span class="c1"># project depth map to 3D</span>
    <span class="n">cloud</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">create_from_depth_image</span><span class="p">(</span><span class="n">depth_map</span><span class="p">,</span> <span class="n">intrins</span><span class="p">,</span> <span class="n">extrins</span><span class="p">,</span> <span class="n">depth_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_trunc</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

    <span class="c1"># color point cloud</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">Vector3dVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">points</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">color</span><span class="p">))</span>
    <span class="n">cloud</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span>

    <span class="k">return</span> <span class="n">cloud</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.points_from_depth" class="doc doc-heading">
<code class="highlight language-python"><span class="n">points_from_depth</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">cam</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Creates a point array from a single depth map.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>depth</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Depth map to project to 3D.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cam</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Camera parameters for the given depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>An array of 3D points corresponding to the input depth map.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">points_from_depth</span><span class="p">(</span><span class="n">depth</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cam</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a point array from a single depth map.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        depth: Depth map to project to 3D.</span>
<span class="sd">        cam: Camera parameters for the given depth map viewpoint.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An array of 3D points corresponding to the input depth map.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># project depth map to point cloud</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;xy&quot;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">xyz_cam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cam</span><span class="p">[</span><span class="mi">1</span><span class="p">,:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="o">*</span> <span class="n">depth</span><span class="p">)</span>
    <span class="n">xyz_world</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cam</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="mi">4</span><span class="p">,:</span><span class="mi">4</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xyz_cam</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">))))[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">xyz_world</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">points</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.project_depth_map" class="doc doc-heading">
<code class="highlight language-python"><span class="n">project_depth_map</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Projects a depth map into a list of 3D points</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>depth</code></td>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>Input depth map to project.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cam</code></td>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>Camera parameters for input depth map.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>A float Tensor of 3D points corresponding to the projected depth values.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">project_depth_map</span><span class="p">(</span><span class="n">depth</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">cam</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Projects a depth map into a list of 3D points</span>

<span class="sd">    Parameters:</span>
<span class="sd">        depth: Input depth map to project.</span>
<span class="sd">        cam: Camera parameters for input depth map.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A float Tensor of 3D points corresponding to the projected depth values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">batch_size</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">cam_shape</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># get camera extrinsics and intrinsics</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">cam</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">cam</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,:]</span>
    <span class="n">K</span><span class="p">[:,</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># construct back-projection from invers matrices</span>
    <span class="c1"># separate into rotation and translation components</span>
    <span class="n">bwd_projection</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">P</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">K</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">bwd_rotation</span> <span class="o">=</span> <span class="n">bwd_projection</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">bwd_translation</span> <span class="o">=</span> <span class="n">bwd_projection</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>

    <span class="c1"># build 2D homogeneous coordinates tensor: [B, 3, H*W]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">row_span</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">col_span</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">row_span</span><span class="p">,</span> <span class="n">col_span</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
        <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">height</span><span class="o">*</span><span class="n">width</span><span class="p">),</span> <span class="n">c</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">height</span><span class="o">*</span><span class="n">width</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># compute 3D coordinates using the depth map: [B, H*W, 3]</span>
    <span class="n">world_coords</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">bwd_rotation</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">world_coords</span> <span class="o">=</span> <span class="n">world_coords</span> <span class="o">*</span> <span class="n">depth</span>
    <span class="n">world_coords</span> <span class="o">=</span> <span class="n">world_coords</span> <span class="o">+</span> <span class="n">bwd_translation</span>

    <span class="c1">#TODO: make sure index select is differentiable</span>
    <span class="c1">#       (there is a backward function but need to find the code..)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">world_coords</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">world_coords</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">non_zero_inds</span><span class="p">)</span>
        <span class="n">world_coords</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">movedim</span><span class="p">(</span><span class="n">world_coords</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># reshape 3D coordinates back into 2D map: [B, H, W, 3]</span>
    <span class="c1">#   coords_map = world_coords.reshape(batch_size, height, width, 3)</span>

    <span class="k">return</span> <span class="n">world_coords</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.project_renderer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">project_renderer</span><span class="p">(</span><span class="n">renderer</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Projects the scene in an Open3D Offscreen Renderer to the 2D image plane.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>renderer</code></td>
          <td>
                <code><span title="open3d">o3d</span>.<span title="open3d.visualization">visualization</span>.<span title="o3d.visualization.rendering">rendering</span>.<span title="o3d.visualization.rendering.OffscreenRenderer">OffscreenRenderer</span></code>
          </td>
          <td><p>Geometric scene to be projected.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>K</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Camera intrinsic parameters.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>P</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Camera extrinsic parameters.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>width</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Desired image width.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>height</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Desired image height.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The rendered image for the scene at the specified camera viewpoint.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">project_renderer</span><span class="p">(</span><span class="n">renderer</span><span class="p">:</span> <span class="n">o3d</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">rendering</span><span class="o">.</span><span class="n">OffscreenRenderer</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">P</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Projects the scene in an Open3D Offscreen Renderer to the 2D image plane.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        renderer: Geometric scene to be projected.</span>
<span class="sd">        K: Camera intrinsic parameters.</span>
<span class="sd">        P: Camera extrinsic parameters.</span>
<span class="sd">        width: Desired image width.</span>
<span class="sd">        height: Desired image height.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The rendered image for the scene at the specified camera viewpoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set up the renderer</span>
    <span class="n">intrins</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">PinholeCameraIntrinsic</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">K</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">K</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">renderer</span><span class="o">.</span><span class="n">setup_camera</span><span class="p">(</span><span class="n">intrins</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>

    <span class="c1"># render image</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">renderer</span><span class="o">.</span><span class="n">render_to_image</span><span class="p">())</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.render_custom_values" class="doc doc-heading">
<code class="highlight language-python"><span class="n">render_custom_values</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">,</span> <span class="n">cam</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Renders a point cloud into a 2D camera plane using custom values for each pixel.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>points</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>List of 3D points to be rendered.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>values</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>List of values to be written in the rendered image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>image_shape</code></td>
          <td>
                <code><span title="typing.Tuple">Tuple</span>[int, int]</code>
          </td>
          <td><p>Desired shape (height,width) of the rendered image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cam</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Camera parameters for the image viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The rendered image for the list of points using the sepcified corresponding values.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">render_custom_values</span><span class="p">(</span><span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">],</span> <span class="n">cam</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Renders a point cloud into a 2D camera plane using custom values for each pixel.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        points: List of 3D points to be rendered.</span>
<span class="sd">        values: List of values to be written in the rendered image.</span>
<span class="sd">        image_shape: Desired shape (height,width) of the rendered image.</span>
<span class="sd">        cam: Camera parameters for the image viewpoint.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The rendered image for the list of points using the sepcified corresponding values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
    <span class="n">cam</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">rendered_img</span> <span class="o">=</span> <span class="n">rd</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">image_shape</span><span class="p">),</span> <span class="n">points</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">cam</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rendered_img</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.render_point_cloud" class="doc doc-heading">
<code class="highlight language-python"><span class="n">render_point_cloud</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Renders a point cloud into a 2D image plane.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>cloud</code></td>
          <td>
                <code><span title="open3d">o3d</span>.<span title="open3d.geometry">geometry</span>.<span title="o3d.geometry.PointCloud">PointCloud</span></code>
          </td>
          <td><p>Point cloud to be rendered.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cam</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Camera parameters for the image plane.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>width</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Desired width of the rendered image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>height</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Desired height of the rendered image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The rendered image for the point cloud at the specified camera viewpoint.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">render_point_cloud</span><span class="p">(</span><span class="n">cloud</span><span class="p">:</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">PointCloud</span><span class="p">,</span> <span class="n">cam</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Renders a point cloud into a 2D image plane.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        cloud: Point cloud to be rendered.</span>
<span class="sd">        cam: Camera parameters for the image plane.</span>
<span class="sd">        width: Desired width of the rendered image.</span>
<span class="sd">        height: Desired height of the rendered image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The rendered image for the point cloud at the specified camera viewpoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#   cmap = plt.get_cmap(&quot;hot_r&quot;)</span>
    <span class="c1">#   colors = cmap(dists)[:, :3]</span>
    <span class="c1">#   ply.colors = o3d.utility.Vector3dVector(colors)</span>

    <span class="c1"># set up the renderer</span>
    <span class="n">render</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">rendering</span><span class="o">.</span><span class="n">OffscreenRenderer</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">rendering</span><span class="o">.</span><span class="n">MaterialRecord</span><span class="p">()</span>
    <span class="n">mat</span><span class="o">.</span><span class="n">shader</span> <span class="o">=</span> <span class="s1">&#39;defaultUnlit&#39;</span>
    <span class="n">render</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">add_geometry</span><span class="p">(</span><span class="s2">&quot;cloud&quot;</span><span class="p">,</span> <span class="n">cloud</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
    <span class="n">render</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">set_background</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span> <span class="c1">#r,g,b,a</span>
    <span class="n">intrins</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">PinholeCameraIntrinsic</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">cam</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">cam</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">cam</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">cam</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">render</span><span class="o">.</span><span class="n">setup_camera</span><span class="p">(</span><span class="n">intrins</span><span class="p">,</span> <span class="n">cam</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># render image</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">render</span><span class="o">.</span><span class="n">render_to_image</span><span class="p">())</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.reproject" class="doc doc-heading">
<code class="highlight language-python"><span class="n">reproject</span><span class="p">(</span><span class="n">src_depth</span><span class="p">,</span> <span class="n">src_K</span><span class="p">,</span> <span class="n">src_P</span><span class="p">,</span> <span class="n">tgt_depth</span><span class="p">,</span> <span class="n">tgt_K</span><span class="p">,</span> <span class="n">tgt_P</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Computes the re-projection depth values and pixel indices between two depth maps.</p>
<p>This function takes as input two depth maps: 'src_depth' and 'tgt_depth'. The source
depth map is first projected into the target camera plane using the source depth
values and the camera parameters for both views. Using the projected pixel
coordinates in the target view, the target depths are then re-projected back into
the source camera plane (again with the camera parameters for both views). The
information prouced from this process is often used to compute errors in
re-projection between two depth maps, or similar operations.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src_depth</code></td>
          <td>
          </td>
          <td><p>Source depth map to be projected.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>src_K</code></td>
          <td>
          </td>
          <td><p>Intrinsic camera parameters for the source depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>src_P</code></td>
          <td>
          </td>
          <td><p>Extrinsic camera parameters for the source depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_depth</code></td>
          <td>
          </td>
          <td><p>Target depth map used for re-projection.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_K</code></td>
          <td>
          </td>
          <td><p>Intrinsic camera parameters for the target depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_P</code></td>
          <td>
          </td>
          <td><p>Extrinsic camera parameters for the target depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>depth_reprojected</code></td>          <td>
          </td>
          <td><p>The re-projected depth values for the source depth map.</p></td>
        </tr>
        <tr>
<td><code>coords_reprojected</code></td>          <td>
          </td>
          <td><p>The re-projection coordinates for the source view.</p></td>
        </tr>
        <tr>
<td><code>coords_tgt</code></td>          <td>
          </td>
          <td><p>The projected coordinates for the target view.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">reproject</span><span class="p">(</span><span class="n">src_depth</span><span class="p">,</span> <span class="n">src_K</span><span class="p">,</span> <span class="n">src_P</span><span class="p">,</span> <span class="n">tgt_depth</span><span class="p">,</span> <span class="n">tgt_K</span><span class="p">,</span> <span class="n">tgt_P</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the re-projection depth values and pixel indices between two depth maps.</span>

<span class="sd">    This function takes as input two depth maps: &#39;src_depth&#39; and &#39;tgt_depth&#39;. The source</span>
<span class="sd">    depth map is first projected into the target camera plane using the source depth</span>
<span class="sd">    values and the camera parameters for both views. Using the projected pixel</span>
<span class="sd">    coordinates in the target view, the target depths are then re-projected back into</span>
<span class="sd">    the source camera plane (again with the camera parameters for both views). The</span>
<span class="sd">    information prouced from this process is often used to compute errors in</span>
<span class="sd">    re-projection between two depth maps, or similar operations.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        src_depth: Source depth map to be projected.</span>
<span class="sd">        src_K: Intrinsic camera parameters for the source depth map viewpoint.</span>
<span class="sd">        src_P: Extrinsic camera parameters for the source depth map viewpoint.</span>
<span class="sd">        tgt_depth: Target depth map used for re-projection.</span>
<span class="sd">        tgt_K: Intrinsic camera parameters for the target depth map viewpoint.</span>
<span class="sd">        tgt_P: Extrinsic camera parameters for the target depth map viewpoint.</span>

<span class="sd">    Returns:</span>
<span class="sd">        depth_reprojected: The re-projected depth values for the source depth map.</span>
<span class="sd">        coords_reprojected: The re-projection coordinates for the source view.</span>
<span class="sd">        coords_tgt: The projected coordinates for the target view.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch_size</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">src_depth</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># back-project ref depths to 3D</span>
    <span class="n">x_src</span><span class="p">,</span> <span class="n">y_src</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;xy&quot;</span><span class="p">)</span>
    <span class="n">x_src</span> <span class="o">=</span> <span class="n">x_src</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">src_depth</span><span class="p">)</span>
    <span class="n">y_src</span> <span class="o">=</span> <span class="n">y_src</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">src_depth</span><span class="p">)</span>
    <span class="n">homog</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">x_src</span><span class="p">,</span> <span class="n">y_src</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_src</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xyz_src</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">src_K</span><span class="p">),</span> <span class="n">homog</span> <span class="o">*</span> <span class="n">src_depth</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># transform 3D points from ref to src coords</span>
    <span class="n">homog_3d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xyz_src</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_src</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xyz_tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">tgt_P</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">src_P</span><span class="p">)),</span> <span class="n">homog_3d</span><span class="p">)[:,:</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># project src 3D points into pixel coords</span>
    <span class="n">K_xyz_tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">tgt_K</span><span class="p">,</span> <span class="n">xyz_tgt</span><span class="p">)</span>
    <span class="n">xy_tgt</span> <span class="o">=</span> <span class="n">K_xyz_tgt</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">K_xyz_tgt</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">x_tgt</span> <span class="o">=</span> <span class="n">xy_tgt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y_tgt</span> <span class="o">=</span> <span class="n">xy_tgt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">coords_tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">x_tgt</span><span class="p">,</span> <span class="n">y_tgt</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># B x H x W x 2</span>

    <span class="c1"># sample the depth values from the src map at each pixel coord</span>
    <span class="n">x_normalized</span> <span class="o">=</span> <span class="p">((</span><span class="n">x_tgt</span> <span class="o">/</span> <span class="p">(</span><span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">y_normalized</span> <span class="o">=</span> <span class="p">((</span><span class="n">y_tgt</span> <span class="o">/</span> <span class="p">(</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">x_normalized</span><span class="p">,</span> <span class="n">y_normalized</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># B x H x W x 2</span>
    <span class="n">sampled_depth_tgt</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span>
                                    <span class="n">tgt_depth</span><span class="p">,</span>
                                    <span class="n">grid</span><span class="p">,</span>
                                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
                                    <span class="n">padding_mode</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span>
                                    <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># back-project src depths to 3D</span>
    <span class="n">homog</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xy_tgt</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_src</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xyz_tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">tgt_K</span><span class="p">),</span> <span class="n">homog</span> <span class="o">*</span> <span class="n">sampled_depth_tgt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># transform 3D points from src to ref coords</span>
    <span class="n">homog_3d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xyz_tgt</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_src</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xyz_reprojected</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">src_P</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">tgt_P</span><span class="p">)),</span> <span class="n">homog_3d</span><span class="p">)[:,:</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># extract reprojected depth values</span>
    <span class="n">depth_reprojected</span> <span class="o">=</span> <span class="n">xyz_reprojected</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># project ref 3D points into pixel coords</span>
    <span class="n">K_xyz_reprojected</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">src_K</span><span class="p">,</span> <span class="n">xyz_reprojected</span><span class="p">)</span>
    <span class="n">xy_reprojected</span> <span class="o">=</span> <span class="n">K_xyz_reprojected</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_xyz_reprojected</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-7</span><span class="p">)</span>
    <span class="n">x_reprojected</span> <span class="o">=</span> <span class="n">xy_reprojected</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y_reprojected</span> <span class="o">=</span> <span class="n">xy_reprojected</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">coords_reprojected</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">x_reprojected</span><span class="p">,</span> <span class="n">y_reprojected</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># B x H x W x 2</span>

    <span class="k">return</span> <span class="n">depth_reprojected</span><span class="p">,</span> <span class="n">coords_reprojected</span><span class="p">,</span> <span class="n">coords_tgt</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.visibility_mask" class="doc doc-heading">
<code class="highlight language-python"><span class="n">visibility_mask</span><span class="p">(</span><span class="n">src_depth</span><span class="p">,</span> <span class="n">src_cam</span><span class="p">,</span> <span class="n">depth_files</span><span class="p">,</span> <span class="n">cam_files</span><span class="p">,</span> <span class="n">src_ind</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">pixel_th</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Computes a visibility mask between a provided source depth map and list of target depth maps.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src_depth</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Depth map for the source view.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>src_cam</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Camera parameters for the source depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>depth_files</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>List of target depth maps.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cam_files</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>List of corresponding target camera parameters for each targte depth map viewpoint.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>src_ind</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Index into 'depth_files' corresponding to the source depth map (if included in the list).</p></td>
          <td>
                <code>-1</code>
          </td>
        </tr>
        <tr>
          <td><code>pixel_th</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Pixel re-projection threshold to determine matching depth estimates.</p></td>
          <td>
                <code>0.1</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The visibility mask for the source view.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">visibility_mask</span><span class="p">(</span><span class="n">src_depth</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">src_cam</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">depth_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cam_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">src_ind</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">pixel_th</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes a visibility mask between a provided source depth map and list of target depth maps.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        src_depth: Depth map for the source view.</span>
<span class="sd">        src_cam: Camera parameters for the source depth map viewpoint.</span>
<span class="sd">        depth_files: List of target depth maps.</span>
<span class="sd">        cam_files: List of corresponding target camera parameters for each targte depth map viewpoint.</span>
<span class="sd">        src_ind: Index into &#39;depth_files&#39; corresponding to the source depth map (if included in the list).</span>
<span class="sd">        pixel_th: Pixel re-projection threshold to determine matching depth estimates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The visibility mask for the source view.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">src_depth</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">vis_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">not_equal</span><span class="p">(</span><span class="n">src_depth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">depth_files</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">src_ind</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># get files</span>
        <span class="n">sdf</span> <span class="o">=</span> <span class="n">depth_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">scf</span> <span class="o">=</span> <span class="n">cam_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># load data</span>
        <span class="n">tgt_depth</span> <span class="o">=</span> <span class="n">read_pfm</span><span class="p">(</span><span class="n">sdf</span><span class="p">)</span>
        <span class="n">tgt_cam</span> <span class="o">=</span> <span class="n">read_single_cam_sfm</span><span class="p">(</span><span class="n">scf</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">geometric_consistency_mask</span><span class="p">(</span><span class="n">src_depth</span><span class="p">,</span> <span class="n">src_cam</span><span class="p">,</span> <span class="n">tgt_depth</span><span class="p">,</span> <span class="n">tgt_cam</span><span class="p">,</span> <span class="n">pixel_th</span><span class="p">)</span>
        <span class="n">vis_map</span> <span class="o">+=</span> <span class="n">mask</span>

    <span class="k">return</span> <span class="n">vis_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="cvt.geometry.warp_to_tgt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">warp_to_tgt</span><span class="p">(</span><span class="n">tgt_depth</span><span class="p">,</span> <span class="n">tgt_conf</span><span class="p">,</span> <span class="n">ref_cam</span><span class="p">,</span> <span class="n">tgt_cam</span><span class="p">,</span> <span class="n">depth_planes</span><span class="p">,</span> <span class="n">depth_vol</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Performs a homography warping</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>tgt_depth</code></td>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_conf</code></td>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ref_cam</code></td>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tgt_cam</code></td>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>depth_planes</code></td>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>depth_vol</code></td>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>depth_diff</code></td>          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td></td>
        </tr>
        <tr>
<td><code>warped_conf</code></td>          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cvt/geometry.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">warp_to_tgt</span><span class="p">(</span><span class="n">tgt_depth</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">tgt_conf</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">ref_cam</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">tgt_cam</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">depth_planes</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">depth_vol</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs a homography warping</span>
<span class="sd">    Parameters:</span>
<span class="sd">        tgt_depth: </span>
<span class="sd">        tgt_conf: </span>
<span class="sd">        ref_cam:</span>
<span class="sd">        tgt_cam:</span>
<span class="sd">        depth_planes:</span>
<span class="sd">        depth_vol:</span>

<span class="sd">    Returns:</span>
<span class="sd">        depth_diff:</span>
<span class="sd">        warped_conf:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch_size</span><span class="p">,</span> <span class="n">views</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">tgt_depth</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># grab intrinsics and extrinsics from reference view</span>
    <span class="n">P_ref</span> <span class="o">=</span> <span class="n">ref_cam</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">K_ref</span> <span class="o">=</span> <span class="n">ref_cam</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,:]</span>
    <span class="n">K_ref</span><span class="p">[:,</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># get intrinsics and extrinsics from target view</span>
    <span class="n">P_tgt</span> <span class="o">=</span> <span class="n">tgt_cam</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">K_tgt</span> <span class="o">=</span> <span class="n">tgt_cam</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,:]</span>
    <span class="n">K_tgt</span><span class="p">[:,</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">R_tgt</span> <span class="o">=</span> <span class="n">P_tgt</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">t_tgt</span> <span class="o">=</span> <span class="n">P_tgt</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">C_tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="o">-</span><span class="n">R_tgt</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">t_tgt</span><span class="p">)</span>
    <span class="n">z_tgt</span> <span class="o">=</span> <span class="n">R_tgt</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">depth_planes</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span><span class="n">width</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="c1"># shape camera center vector</span>
        <span class="n">C_tgt</span> <span class="o">=</span> <span class="n">C_tgt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">depth_planes</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">bwd_proj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">P_ref</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">K_ref</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">fwd_proj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">K_tgt</span><span class="p">,</span> <span class="n">P_tgt</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">bwd_rot</span> <span class="o">=</span> <span class="n">bwd_proj</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">bwd_trans</span> <span class="o">=</span> <span class="n">bwd_proj</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>

        <span class="n">proj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">fwd_proj</span><span class="p">,</span> <span class="n">bwd_proj</span><span class="p">)</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="n">proj</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">proj</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>

        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">tgt_depth</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                                     <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tgt_depth</span><span class="o">.</span><span class="n">device</span><span class="p">)],</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">height</span><span class="o">*</span><span class="n">width</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">height</span><span class="o">*</span><span class="n">width</span><span class="p">)</span>
        <span class="n">homog</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">homog</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">homog</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># get world coords</span>
        <span class="n">world_coords</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">bwd_rot</span><span class="p">,</span> <span class="n">homog</span><span class="p">)</span>
        <span class="n">world_coords</span> <span class="o">=</span> <span class="n">world_coords</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">depth_planes</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">depth_vol</span> <span class="o">=</span> <span class="n">depth_vol</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">depth_planes</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">world_coords</span> <span class="o">=</span> <span class="n">world_coords</span> <span class="o">*</span> <span class="n">depth_vol</span>
        <span class="n">world_coords</span> <span class="o">=</span> <span class="n">world_coords</span> <span class="o">+</span> <span class="n">bwd_trans</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">world_coords</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">movedim</span><span class="p">(</span><span class="n">world_coords</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">world_coords</span> <span class="o">=</span> <span class="n">world_coords</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">depth_planes</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># get pixel projection</span>
        <span class="n">rot_coords</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">rot</span><span class="p">,</span> <span class="n">homog</span><span class="p">)</span>
        <span class="n">rot_coords</span> <span class="o">=</span> <span class="n">rot_coords</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">depth_planes</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">proj_3d</span> <span class="o">=</span> <span class="n">rot_coords</span> <span class="o">*</span> <span class="n">depth_vol</span>
        <span class="n">proj_3d</span> <span class="o">=</span> <span class="n">proj_3d</span> <span class="o">+</span> <span class="n">trans</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">proj_2d</span> <span class="o">=</span> <span class="n">proj_3d</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">proj_3d</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">,:,:]</span>

        <span class="n">proj_x</span> <span class="o">=</span> <span class="n">proj_2d</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="p">((</span><span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">proj_y</span> <span class="o">=</span> <span class="n">proj_2d</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="p">((</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">proj_2d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">proj_x</span><span class="p">,</span> <span class="n">proj_y</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">proj_2d</span>


    <span class="n">proj_depth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">world_coords</span><span class="p">,</span> <span class="n">C_tgt</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">proj_depth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">z_tgt</span><span class="p">,</span> <span class="n">proj_depth</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="n">depth_planes</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">width</span><span class="p">)</span>

    <span class="n">warped_depth</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">tgt_depth</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">depth_planes</span><span class="o">*</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">warped_depth</span> <span class="o">=</span> <span class="n">warped_depth</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">depth_planes</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

    <span class="n">warped_conf</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">tgt_conf</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">depth_planes</span><span class="o">*</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">warped_conf</span> <span class="o">=</span> <span class="n">warped_conf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">depth_planes</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

    <span class="n">depth_diff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">proj_depth</span><span class="p">,</span> <span class="n">warped_depth</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">depth_diff</span><span class="p">,</span> <span class="n">warped_conf</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.top"], "search": "../../assets/javascripts/workers/search.12658920.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5cf534bf.min.js"></script>
      
    
  </body>
</html>